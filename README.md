# Ad Alchemy

По ссылке на группу ВКонтакте бот анализирует группу и последние 50 постов, считает engagement, прогоняет данные через цепочку промптов (анализ → объявления → промпт для картинки) и отдаёт в Telegram: анализ, варианты объявлений и промпты для генерации изображений.

## Цепочка промптов

1. **Анализ ВК** — на основе названия, описания, участников и топ-постов по engagement: темы, аудитория, форматы, рекламные углы, сегменты, ключевые слова. Ответ в JSON.
2. **Генерация объявлений** — по результатам анализа: 2–4 варианта с заголовком, текстом, CTA, визуальной концепцией и коротким описанием для картинки. Ответ в JSON.
3. **Промпт для картинки** — для каждого варианта: детальный фотореалистичный промпт под баннер ВК (без текста на изображении). Только текст.
4. **Генерация изображения** — пока не реализована; в Telegram отправляются данные для объявления и готовый промпт для визуальной нейросети.

## Установка

```bash
python -m venv .venv
.venv\Scripts\activate   # Windows
pip install -r requirements.txt
```

## Настройка

1. Скопируйте `.env.example` в `.env`.
2. **Telegram:** создайте бота через [@BotFather](https://t.me/BotFather), укажите `TELEGRAM_BOT_TOKEN`.
3. **VK:** access token с правами `groups` → `VK_ACCESS_TOKEN`.
4. **LLM:** любой OpenAI-совместимый API (OpenAI, DeepSeek, Qwen). Укажите `LLM_API_KEY`, при необходимости `LLM_BASE_URL` и `LLM_MODEL`.
5. **Пополнение баланса (YooKassa):** в личном кабинете [YooKassa](https://yookassa.ru) создайте магазин, получите `YOOKASSA_SHOP_ID` и `YOOKASSA_SECRET_KEY`. Выполните миграцию: `mysql ... < sql/payments.sql`. Для зачисления средств после оплаты нужен вебхук — либо PHP-скрипт на nginx (см. ниже), либо Python-сервер: `python -m src.webhook_server`.

## Запуск

```bash
python main.py
```

Отправьте боту ссылку на группу ВК. Бот ответит «Ваше объявление создаётся», затем пришлёт: краткий анализ, ключевые слова и по каждому варианту объявления — заголовок, текст, CTA, визуальную концепцию и **промпт для генерации изображения**.

**Пополнение баланса:** команда `/balance` — отображается текущий баланс и кнопка «Пополнить баланс». После выбора суммы (или ввода своей) бот присылает ссылку на оплату YooKassa. Для зачисления средств после оплаты нужен вебхук:

- **Вариант 1 (nginx):** загрузите папку `webhook/` на сервер (yookassa_webhook.php и создайте из примера yookassa_webhook_config.php). В настройках магазина YooKassa укажите URL: `https://ваш-домен/путь/yookassa_webhook.php`.
- **Вариант 2 (Python):** запустите `python -m src.webhook_server` и укажите в YooKassa URL вида `https://ваш-домен:8080/webhook/yookassa`.

## Структура

- `src/vk_client.py` — данные группы и стены, engagement по формуле `(likes + comments*2 + reposts*3) / views`.
- `src/prompts.py` — системные и пользовательские промпты для шагов 1–3.
- `src/llm_client.py` — вызов OpenAI-совместимого chat completion (JSON и текст).
- `src/campaign_generator.py` — асинхронный пайплайн: анализ → объявления → промпты для картинок.
- `src/bot.py` — Telegram-бот, асинхронная отправка результата.
- `src/yookassa_client.py` — создание платежей YooKassa (пополнение баланса).
- `src/webhook_server.py` — HTTP-сервер для приёма уведомлений YooKassa (альтернатива PHP).
- `webhook/yookassa_webhook.php` — вебхук YooKassa для nginx (пополнение баланса после оплаты).
- `sql/payments.sql` — таблица платежей для пополнения баланса.
